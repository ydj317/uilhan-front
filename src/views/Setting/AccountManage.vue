<template>

	<BindBridge @formUpdated="handleFormUpdate"/>
  <!--     员工表格  -->
  <a-card class="mt20" :loading="formState.loading" :bordered="false" :title="'직원 계정관리'" v-if="isMainUser">
    <template #extra>
      <a-button type="primary" @click="showAccountModal(0,2)">계정 등록</a-button>
    </template>
    <a-table :columns="columns" :data-source="formState.employeeList" :scroll="formState.employeeList.length > 10 ? { y: 650 } : null" bordered :pagination="false">
      <template #headerCell="{ column }">
      </template>
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'menu_name'">
          <a-space wrap>
            <a-tag v-for="menu in record.menu_name">{{ menu }}</a-tag>
          </a-space>
        </template>
        <template v-if="column.key === 'action'">
          <a-button type="primary" class="mr20" @click="showAccountModal(record,2)">수정</a-button>
          <a-popconfirm
            title="삭제하시겠습니까?"
            ok-text="Yes"
            cancel-text="No"
            @confirm="deleteAccount(record.id)"
          >
            <a-button type="default">삭제</a-button>
          </a-popconfirm>
        </template>
      </template>
    </a-table>
  </a-card>
    <!--     子账号表格  -->
    <a-card class="mt20" :loading="formState.loading" :bordered="false" :title="'서브계정 관리'" v-if="isMainUser" style="display: none;">
        <template #extra>
            <a-button type="primary" @click="showAccountModal(0,1)">서브계정 등록</a-button>
        </template>
        <a-table :columns="columnsSubAccount" :data-source="formState.subAccountList" :scroll="formState.subAccountList.length > 10 ? { y: 650 } : null" bordered :pagination="false">
            <template #headerCell="{ column }">
            </template>
            <template #bodyCell="{ column, record }">
                <template v-if="column.key === 'action'">
                    <a-button type="primary" class="mr20" @click="showAccountModal(record,1)">수정</a-button>
                  <a-popconfirm
                    title="삭제하시겠습니까?"
                    ok-text="Yes"
                    cancel-text="No"
                    @confirm="deleteAccount(record.id)"
                  >
                    <a-button type="default">삭제</a-button>
                  </a-popconfirm>
                </template>
            </template>
        </a-table>
    </a-card>
  <a-card class="mt20" :loading="formState.loading" :bordered="false" :title="'직원 계정 수정'" v-if="isMainUser">

    <a-form :rules="rulesRef" :model="formState" name="user_form" class="user_form" autocomplete="off"
            @finish="onFinish" @finishFailed="onFinishFailed">

      <a-form-item label="아이디">
        {{ formState.username }}
      </a-form-item>
      <a-form-item label="비밀번호">
        <span class="mr30">*******</span>
        <a-button type="primary" @click="showModal">비밀번호 변경</a-button>
      </a-form-item>

      <a-form-item label="추천코드">
        <a-button @click="copyText(formState.username)">
          {{ formState.username }}
          <CopyOutlined/>
        </a-button>
      </a-form-item>

      <a-form-item label="사용자명" name="name" has-feedback>
        <a-input v-model:value="formState.name" placeholder="사용자명을 입력해주시오"/>
      </a-form-item>

      <a-form-item label="Email" name="email" has-feedback>
        <a-input v-model:value="formState.email" placeholder="Email을 입력해주시오"/>
      </a-form-item>

      <a-form-item label="휴대전화" name="phone1">
        <a-row :gutter="10">
          <a-col style="width: 160px;">
            <a-form-item name="phone1" class="phone" has-feedback>
              <a-input v-model:value="formState.phone1" placeholder="휴대전화"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="phone2" class="phone" has-feedback>
              <a-input v-model:value="formState.phone2" placeholder="휴대전화"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="phone3" class="phone" has-feedback>
              <a-input v-model:value="formState.phone3" placeholder="휴대전화"/>
            </a-form-item>
          </a-col>
        </a-row>
      </a-form-item>

      <a-form-item label="업체명/사업자명" name="com_name" has-feedback>
        <a-input v-model:value="formState.com_name" placeholder="업체명/사업자명을 입력해주시오"/>
      </a-form-item>

      <a-form-item label="사업자번호" name="com_number" has-feedback>
        <a-input v-model:value="formState.com_number" placeholder="사업자번호를 입력해주시오"/>
      </a-form-item>

      <a-form-item label="사업자등록증" name="business_license_image" has-feedback class="upload">
        <a-upload
          name="business_license_image"
          list-type="picture-card"
          :show-upload-list="false"
          :before-upload="validateUploadImage"
          :custom-request="uploadImage"
        >
          <img v-if="formState.business_license_image" :src="formState.business_license_image" alt="business_license_image" style="width:100%;height:100%; object-fit: contain;" @click="showBigImageOnClick($event)" />
          <div v-else>
            <loading-outlined v-if="loading"></loading-outlined>
            <plus-outlined v-else></plus-outlined>
            <div class="ant-upload-text">업로드</div>
          </div>
          <template v-if="formState.business_license_image">
            <close-circle-outlined class="delete-image" @click="removeLicenseImage($event)" />
          </template>
        </a-upload>
        <div v-if="showBigImage" class="big-image" @click="showBigImage = false">
          <img :src="formState.business_license_image" alt="Big Business License" />
        </div>
      </a-form-item>

      <a-form-item label="사업장 전화번호" name="com_phone1">
        <a-row :gutter="10">
          <a-col style="width: 160px;">
            <a-form-item name="com_phone1" class="phone" has-feedback>
              <a-input v-model:value="formState.com_phone1" placeholder="전화번호"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="com_phone2" class="phone" has-feedback>
              <a-input v-model:value="formState.com_phone2" placeholder="전화번호"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="com_phone3" class="phone" has-feedback>
              <a-input v-model:value="formState.com_phone3" placeholder="전화번호"/>
            </a-form-item>
          </a-col>
        </a-row>
      </a-form-item>

      <a-form-item label="대표자명" name="com_ceo" has-feedback>
        <a-input v-model:value="formState.com_ceo" placeholder="대표자명을 입력해주시오"/>
      </a-form-item>

      <a-form-item label="유선전화" name="tel1">
        <a-row :gutter="10">
          <a-col style="width: 160px;">
            <a-form-item name="tel1" class="phone" has-feedback>
              <a-input v-model:value="formState.tel1" placeholder="유선전화"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="tel2" class="phone" has-feedback>
              <a-input v-model:value="formState.tel2" placeholder="유선전화"/>
            </a-form-item>
          </a-col>
          <a-col style="width: 160px;">
            <a-form-item name="tel3" class="phone" has-feedback>
              <a-input v-model:value="formState.tel3" placeholder="유선전화"/>
            </a-form-item>
          </a-col>
        </a-row>
      </a-form-item>

      <div style="display: flex;justify-content: center;margin-top: 20px;">
        <a-button type="primary" html-type="submit">저장</a-button>
        <a-button style="margin-left: 10px" @click="router.back()">취소</a-button>
      </div>
    </a-form>

  </a-card>
  <a-modal class="add-account" v-model:open="formState.accountModal.open" :title="formState.accountModal.id ? '직원 계정 수정' : '직원 계정 등록'" width="600px"  :footer="null" :closable="false" @cancel="accountModalClose">
    <a-form
      :rules="accountRulesRef"
      :model="formState.accountModal"
      name="addAccount"
      ref="addAccountRef"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
      autocomplete="off"
      @finish="addAccount"
    >
      <a-form-item label="아이디" name="username" has-feedback>
        <a-input v-model:value="formState.accountModal.username" placeholder="아이디를 입력해주세요" />
      </a-form-item>
      <a-form-item label="비밀번호" v-if="formState.accountModal.id">
        <a-button type="primary" @click="formState.accountModal.showPassword=!formState.accountModal.showPassword">비밀번호 변경</a-button>
      </a-form-item>
      <a-form-item label="비밀번호" name="password" has-feedback v-if="!formState.accountModal.showPassword">
        <a-input-password v-model:value="formState.accountModal.password" v-model:visible="formState.accountModal.password_visible" :placeholder="formState.accountModal.id ? '비어 있으면 수정이 이루어지지 않습니다.' : '비밀번호를 입력 해주세요'" />
      </a-form-item>
      <a-form-item label="비밀번호 확인" name="password_confirm" has-feedback v-if="!formState.accountModal.showPassword">
        <a-input-password v-model:value="formState.accountModal.password_confirm" v-model:visible="formState.accountModal.password_confirm_visible" :placeholder="formState.accountModal.id ? '비어 있으면 수정이 이루어지지 않습니다.' : '비밀번호를 입력 해주세요'" />
      </a-form-item>
      <a-form-item label="권한" name="auth" has-feedback v-if="formState.modalType==2">
        <a-collapse v-model:activeKey="formState.accountModal.activePanel">
          <a-collapse-panel
            v-for="(item, index) in formState.accountModal.menuList"
            :key="item.id"
            :header="panelHeader(item, index)"
          >
            <template v-if="item.child && item.child.length">
              <a-collapse ghost>
                <a-collapse-panel
                  v-for="(child, childIndex) in item.child"
                  :key="child.id"
                  :header="panelHeader(child, childIndex, index)"
                  :showArrow="false"
                >
                </a-collapse-panel>
              </a-collapse>
            </template>
          </a-collapse-panel>
        </a-collapse>
      </a-form-item>
      <div style="display: flex;justify-content: center;margin-top: 20px;">
        <a-button type="primary" html-type="submit" :loading="formState.accountModal.loading">저장</a-button>
        <a-button style="margin-left: 10px" @click="accountModalClose">취소</a-button>
      </div>
    </a-form>
  </a-modal>
    
    <!--    修改密码-->
<!--    <a-modal v-model:open="formState.pwdOpen" width="1000px"  :footer="null" :closable="false">-->
<!--        <a-card :bordered="false" :title="'비밀번호 변경'">-->

<!--            <a-form :rules="rulesRef" :model="formState" name="user_form2" class="user_form" autocomplete="off"-->
<!--                    @finish="onFinish2" @finishFailed="onFinishFailed2">-->

<!--                <a-form-item label="기존 비밀번호" name="password" has-feedback>-->
<!--                    <a-input-password v-model:value="formState.password"-->
<!--                                      type="password" placeholder="기존 비밀번호를 입력해주십시오" />-->
<!--                </a-form-item>-->

<!--                <a-form-item label="새로운 비밀번호" name="new_password" has-feedback>-->
<!--                    <a-input-password v-model:value="formState.new_password"-->
<!--                                      type="password" placeholder="새로운 비밀번호 길이는 최소 8자 최대 20자 이내로 입력해주십시오" />-->
<!--                </a-form-item>-->

<!--                <a-form-item label="비밀번호 확인" name="password_confirm" has-feedback>-->
<!--                    <a-input-password v-model:value="formState.password_confirm"-->
<!--                                      type="password" placeholder="새로운 비밀번호를 한번 더 입력해주십시오" />-->
<!--                </a-form-item>-->

<!--                <div style="display: flex;justify-content: center;margin-top: 20px;">-->
<!--                    <a-button  @click="handleCancel">취 소</a-button>-->
<!--                    <a-button style="margin-left: 10px" type="primary" html-type="submit" :loading="formState.pwdLoading">저장</a-button>-->
<!--                </div>-->
<!--            </a-form>-->

<!--        </a-card>-->
<!--    </a-modal>-->
    <!--    注冊账户-->
<!--    <a-modal v-model:open="formState.regOpen" width="1000px"  :footer="null" :closable="false">-->
<!--        <a-card :bordered="false" :title="'직원 계정 등록'">-->

<!--            <a-form :rules="rulesRef" :model="formState" name="user_form3" class="user_form" autocomplete="off"-->
<!--                    @finish="onFinish3" @finishFailed="onFinishFailed3">-->

<!--                <a-form-item label="직원 아이디" name="ID" has-feedback>-->
<!--                    <a-input v-model:value="formState.ID" placeholder="최소 5자 최대 20자이내로 입력해주십시오" />-->
<!--                </a-form-item>-->
<!--                <a-form-item label="비밀번호" name="reg_new_password" has-feedback>-->
<!--                    <a-input-password v-model:value="formState.reg_new_password" placeholder="비밀번호 길이는 최소 8자 최대 20자 이내로 입력해주십시오" />-->
<!--                </a-form-item>-->
<!--                <a-form-item label="비밀번호 확인" name="reg_password_confirm" has-feedback>-->
<!--                    <a-input-password v-model:value="formState.reg_password_confirm" placeholder="비밀번호와 같게 입력해주십시오" />-->
<!--                </a-form-item>-->
<!--                <a-form-item label="권한설정" name="auth">-->
<!--                    <a-checkbox-group v-model:value="formState.auth" :options="authOptions" />-->
<!--                </a-form-item>-->
<!--                <a-form-item label="할당량" name="number" has-feedback>-->
<!--                    <a-space>-->
<!--                        <a-input v-model:value="formState.number" suffix="개" />-->
<!--                    </a-space>-->
<!--                </a-form-item>-->

<!--                <div style="display: flex;justify-content: center;margin-top: 20px;">-->
<!--                    <a-button  @click="handleCancel2">취 소</a-button>-->
<!--                    <a-button style="margin-left: 10px" type="primary" html-type="submit" :loading="formState.regLoading">저장</a-button>-->
<!--                </div>-->
<!--            </a-form>-->

<!--        </a-card>-->
<!--    </a-modal>-->
</template>

<script setup>
    import {AuthRequest} from "@/util/request";
    import {
      CloseCircleOutlined,
      CopyOutlined, LoadingOutlined, PlusOutlined,
    } from "@ant-design/icons-vue";
    import {onMounted, reactive, ref,h} from "vue";
    import router from "@/router";
    import {message,Checkbox} from "ant-design-vue";
    import {useUserApi} from "@/api/user";
	  import BindBridge from "@/views/Setting/BindBridge.vue";
    import Cookie from "js-cookie";

	  import "vue-loading-overlay/dist/vue-loading.css";
    import Loading from "vue-loading-overlay";
    const main_user = Cookie.get('main_user') ? JSON.parse(Cookie.get('main_user')):''
    const member_name = Cookie.get('member_name')
    const isMainUser = main_user.username == member_name;
    const formState = reactive({
        username: "",
        //[필수] 사용자명/사업자명
        name: "",
        //[필수] 이메일
        email: "",
        //[필수] 휴대전화
        phone1: "",
        phone2: "",
        phone3: "",
        //유선전화
        tel1: "",
        tel2: "",
        tel3: "",
        //[필수] 사업자명/업체명
        com_name: "",
        //[필수] 사업자번호
        com_number: "",
        //사업장전화번호
        com_phone1: "",
        com_phone2: "",
        com_phone3: "",
        //대표자명
        com_ceo: "",

        loading: false,
        //修改密码
        pwdLoading:false,
        pwdOpen:false,
        password: "",
        new_password: "",
        password_confirm: "",
        formRef:"",
        //注册账户
        regLoading:false,

        regOpen:false,
        reg_new_password: "",
        reg_password_confirm: "",
        //默认拥有的账号权限
        auth: ['상품관리 (삭제 제외)', ' 상품삭제'],
		// 배대지 값들
		bridgeData: {
			bind_bridge_id: '',
			bind_bridge_mb_id: '',
			bind_bridge_phone: '',
			bind_bridge_phone1: '',
			bind_bridge_phone2: '',
			bind_bridge_phone3: '',
			bind_bridge_email: '',
			is_bridge_sync: false,
		},
      business_license_image: '',
      employeeList:[],
      subAccountList:[],
      modalType:0,//1=子账号,2=员工账号
      accountModal:{
          open:false,
          loading:false,
          menuList: [],
          id:0,
          username:'',
          password:'',
          password_confirm:'',
          password_visible:false,
          password_confirm_visible:false,
          menu_id:[],
          activePanel:[],
          showPassword:false,
      },
    });

	const handleFormUpdate = (data) => {
		formState.bridgeData = data;
	};

    const headers = reactive({
      token: Cookie.get("token")
    });

    const copyText = (recommend_code) => {
        var textArea = document.createElement("textarea");
        textArea.value = recommend_code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        message.success('복사성공 하였습니다.');
    };

    let validateName = async (rule, value) => {
        if (value === "") {
            return Promise.reject("사용자명을 입력해주십시오");
        } else {
            if (value.length < 2 || value.length > 20) {
                return Promise.reject("사용자명은 최소 2자 최대 20자이내로 입력해주십시오");
            }
        }

        return Promise.resolve();
    };

    let validateEmail = async (rule, value) => {
        if (value === "") {
            return Promise.reject("메일을 입력해주십시오");
        } else {
            let regEmail = /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
            if (regEmail.test(value) !== true) {
                return Promise.reject("메일 격식이 옳바르지 않습니다.");
            }
        }

        return Promise.resolve();
    };

    let validatePhone = async (rule, value) => {
        if (value === "") {
            return Promise.reject("번호를 입력해주십시오");
        } else {
            let regPhone = /^\d{4}$/;
            if (regPhone.test(value) !== true) {
                return Promise.reject("숫자를 입력해주십시오");
            }
        }

        return Promise.resolve();
    };

    let _validatePhone = async (rule, value) => {
        if (value === "") {
            return Promise.reject("번호를 입력해주십시오");
        } else {
            let regPhone = /^\d{4}$/;
            if (regPhone.test(value) !== true) {
                return Promise.reject("숫자를 입력해주십시오");
            }
        }

        return Promise.resolve();
    };

    let validatePhoneFirst = async (rule, value) => {
        if (value === "") {
            return Promise.reject("번호를 입력해주십시오");
        } else {
            let regPhone = /^\d{2,3}$/;
            if (regPhone.test(value) !== true) {
                return Promise.reject("숫자를 입력해주십시오");
            }
        }

        return Promise.resolve();
    };


    let validateTelFirst = async (rule, value) => {
      if (value === "") {
        return Promise.resolve();
      } else {
        let regPhone = /^\d{2,3}$/;
        if (regPhone.test(value) !== true) {
          return Promise.reject("숫자를 입력해주십시오");
        }
      }

      return Promise.resolve();
    };


    let _validateTel = async (rule, value) => {
      if (value === "") {
        return Promise.resolve();
      } else {
        let regPhone = /^\d{4}$/;
        if (regPhone.test(value) !== true) {
          return Promise.reject("숫자를 입력해주십시오");
        }
      }

      return Promise.resolve();
    };

    let validateTel = async (rule, value) => {
      if (value === "") {
        return Promise.resolve();
      } else {
        let regPhone = /^\d{4}$/;
        if (regPhone.test(value) !== true) {
          return Promise.reject("숫자를 입력해주십시오");
        }
      }

      return Promise.resolve();
    };


    let validateComname = async (rule, value) => {
        if (value === "") {
            return Promise.reject("업체 또는 사업자명을 입력해주십시오");
        } else {
            if (value.length < 2 || value.length > 20) {
                return Promise.reject("업체명은 최소 2자 최대 20자이내로 입력해주십시오");
            }
        }

        return Promise.resolve();
    };

    let validateComnumber = async (rule, value) => {
        if (value === "") {
            return Promise.reject("사업자번호를 입력해주십시오");
        } else {
            let comnumber = /^([0-9]{3})-?([0-9]{2})-?([0-9]{5})$/;

            if (comnumber.test(value) !== true) {
                return Promise.reject("사업자번호 격식이 옳바르지 않습니다.");
            }
        }

        return Promise.resolve();
    };

    let validateComCeo = async (rule, value) => {
        if (value === "" || value === null) {
            return Promise.reject("대표자명을 입력해주십시오");
        } else {
            if (value.length < 2 || value.length > 10) {
                return Promise.reject("대표자명은 최소 2자 최대 10자이내로 입력해주십시오");
            }
        }

        return Promise.resolve();
    };

    let validatePass = async (rule, value) => {
        if (value === "") {
            return Promise.reject("기존 비밀번호를 입력해주십시오");
        }

        return Promise.resolve();
    };

    let validateNewPass = async (rule, value) => {
        if (value === "") {
            return Promise.reject("새로운 비밀번호를 입력해주십시오");
        } else {
            if (value.length < 8 || value.length > 20) {
                return Promise.reject("새로운 비밀번호 길이는 최소 8자 최대 20자이내로 입력해주십시오");
            }

            if (formState.password_confirm !== "") {
                formState.formRef.validateFields("password_confirm");
            }

            return Promise.resolve();
        }
    };

    let validatePassConfirm = async (rule, value) => {
        if (value === "") {
            return Promise.reject("비밀번호가 일치하지 않습니다");
        } else if (value !== formState.new_password) {
            return Promise.reject("비밀번호가 일치하지 않습니다");
        } else {
            return Promise.resolve();
        }
    };

    const rulesRef = reactive({
        name: [
            {
                required: true,
                validator: validateName,
                trigger: "blur"
            }
        ],
        email: [
            {
                required: true,
                validator: validateEmail,
                trigger: "blur"
            }
        ],
        phone1: [
            {
                required: true,
                validator: validatePhoneFirst,
                trigger: "blur"
            }
        ],
        phone2: [
            {
                required: true,
                validator: _validatePhone,
                trigger: "blur"
            }
        ],
        phone3: [
            {
                required: true,
                validator: validatePhone,
                trigger: "blur"
            }
        ],
        com_name: [
            {
                required: true,
                validator: validateComname,
                trigger: "blur"
            }
        ],
        com_number: [
            {
                required: true,
                validator: validateComnumber,
                trigger: "blur"
            }
        ],
        com_phone1: [
            {
                required: true,
                validator: validatePhoneFirst,
                trigger: "blur"
            }
        ],
        com_phone2: [
            {
                required: true,
                validator: _validatePhone,
                trigger: "blur"
            }
        ],
        com_phone3: [
            {
                required: true,
                validator: validatePhone,
                trigger: "blur"
            }
        ],
        com_ceo: [
            {
                required: true,
                validator: validateComCeo,
                trigger: "blur"
            }
        ],
        tel1: [
            {
                validator: validateTelFirst,
                trigger: "blur"
            }
        ],
        tel2: [
            {
                validator: _validateTel,
                trigger: "blur"
            }
        ],
        tel3: [
            {
                validator: validateTel,
                trigger: "blur"
            }
        ],
        password: [
            {
                required: true,
                validator: validatePass,
                trigger: "blur"
            }
        ],
        new_password: [
            {
                required: true,
                validator: validateNewPass,
                trigger: "blur"
            }
        ],
        password_confirm: [
            {
                required: true,
                validator: validatePassConfirm,
                trigger: "blur"
            }
        ],
    });

    const onFinish = () => {
        let user = {
            name: formState.name,
            email: formState.email,
            phone: formState.phone1 + "-" + formState.phone2 + "-" + formState.phone3,
            tel: formState.tel1 + "-" + formState.tel2 + "-" + formState.tel3,
            com_name: formState.com_name,
            com_number: formState.com_number,
            com_phone: formState.com_phone1 + "-" + formState.com_phone2 + "-" + formState.com_phone3,
            com_ceo: formState.com_ceo,
			bind_bridge_id: formState.bridgeData.bind_bridge_id,
			bind_bridge_mb_id: formState.bridgeData.bind_bridge_mb_id,
			bind_bridge_phone: formState.bridgeData.bind_bridge_phone1 + "-" + formState.bridgeData.bind_bridge_phone2 + "-" + formState.bridgeData.bind_bridge_phone3,
			bind_bridge_email: formState.bridgeData.bind_bridge_email,
			is_bridge_sync: formState.bridgeData.is_bridge_sync,
          business_license_image: formState.business_license_image
        };

      if (formState.business_license_image === "") {
        message.error("사업자등록증을 첨부해 주세요.");
        return false;
      }

      AuthRequest.post(process.env.VUE_APP_API_URL + "/api/updateUserDetail", user).then((res) => {
          if (res.status !== '2000') {
            message.error(res.message)
            return false;
          }

            message.success(res.message);
            getUserInfoData();
        });
    };

    const onFinishFailed = errorInfo => {
        console.log("Failed:", errorInfo);
    };

    function splitPhone(key, phone) {
        if (phone === undefined || phone === null || phone === '') {
            return false
        }

        if (phone.includes("-")) {
            const phoneArray = phone.split("-");
            formState[key + 1] = phoneArray[0]
            formState[key + 2] = phoneArray[1]
            formState[key + 3] = phoneArray[2]
        } else {
            formState[key + 1] = '';
            formState[key + 2] = phone.slice(-8, -4);
            formState[key + 3] = phone.slice(-4);

            if (phone.length > 8) {
                formState[key + 1] = phone.slice(0, -8);
            }
        }
    }


    const loading= ref(false);

    function validateUploadImage(file) {
      const isJPG = file.type === "image/jpeg";
      const isJPEG = file.type === "image/jpeg";
      const isGIF = file.type === "image/gif";
      const isPNG = file.type === "image/png";

      if (!(isJPG || isJPEG || isPNG || isGIF)) {
        message.warning("허용되는 이미지 격식이 아닙니다.");
        return false;
      }
      return true;
    }

    function uploadImage(options) {
      const { onSuccess, onError, file } = options;
      const formData = new FormData();
      formData.append("file", file);

      loading.value = true;

      AuthRequest.post(
          process.env.VUE_APP_API_URL + "/api/setting/uploadImage",
          formData
      ).then(response => {
        formState.business_license_image = response.data.img_url;
        formState.imageUploaded = true;
        onSuccess(response);
      });
    }


    function getUserInfoData() {
        formState.loading = true;
        useUserApi().getUserInfoData({}).then((res) => {
            if (res.status !== "2000") {
                message.error(res.message);
                formState.loading = false;
                return false;
            }

            formState.username = res.data.username
            formState.name = res.data.name
            formState.email = res.data.email
            splitPhone('phone', res.data.phone)
            formState.com_name = res.data.com_name;
            formState.com_number = res.data.com_number;
            splitPhone('com_phone', res.data.com_phone)
            formState.com_ceo = res.data.com_ceo;
            formState.recommend_code = res.data.recommend_code;
            formState.business_license_image = res.data.business_license_image
            splitPhone('tel', res.data.tel)

            setTimeout(() => {
                formState.loading = false;
            }, 500);

        });
    }

    const showBigImage = ref(false);

    function removeLicenseImage(event){
      formState.business_license_image = "";
      event.stopPropagation();
      loading.value=false;
    }
    function showBigImageOnClick(event) {
      showBigImage.value = true;
      event.stopPropagation();
    }


    onMounted(() => {
        getUserInfoData();
        getAccountList();
        getMenuList();
    });
    const columns = [
        {
            title: 'No.',
            dataIndex: 'No',
            key: 'No',
            width:'5%',
        },
        {
            title: '직원 아이디',
            dataIndex: 'username',
            key: 'username',
            width:'30%',
        },
        {
            title: '권한',
            key: 'menu_name',
            dataIndex: 'menu_name',
            width:'30%',
        },
        {
            title: '계정 등록시간',
            key: 'ins_date',
            dataIndex: 'ins_date',
            width:'20%',
        },
        {
            title: '관리',
            key: 'action',
            width:'15%',
        }
    ];
    const columnsSubAccount = [
      {
        title: 'No.',
        dataIndex: 'No',
        key: 'No',
        width:'5%',
      },
      {
        title: '직원 아이디',
        dataIndex: 'username',
        key: 'username',
        width:'40%',
      },
      {
        title: '계정 등록시간',
        key: 'ins_date',
        dataIndex: 'ins_date',
        width:'40%',
      },
      {
        title: '관리',
        key: 'action',
        width:'15%',
      }
    ];

    //修改密码模态框
    const showModal = () => {
        formState.pwdOpen = true;
    };
    const handleCancel = () => {
        formState.pwdOpen = false;
    };
    const onFinish2 = () => {
        let user = {
            password: formState.password,
            new_password: formState.new_password
        };

        formState.pwdLoading = true;
        AuthRequest.post(process.env.VUE_APP_API_URL + "/api/updateUserDetail", user).then((res) => {
            if (res.status !== "2000") {
                message.error(res.message);
                formState.pwdLoading = false;
                return false;
            }

            message.success(res.message);

            formState.pwdLoading = false;
            formState.pwdOpen = false;
        });
    };

    const onFinishFailed2 = errorInfo => {
        console.log("Failed:", errorInfo);
    };
    //注册账户模态框
    const showModal2 = () => {
        formState.regOpen = true;
    };
    const handleCancel2 = () => {
        formState.regOpen = false;
    };

    const authOptions = ['전체', '상품관리 (삭제 제외)', ' 상품삭제', ' 주문관리'];
    const onFinish3 = () => {
        let user = {
            password: formState.password,
            new_password: formState.new_password
        };

        formState.regLoading = true;
        // AuthRequest.post(process.env.VUE_APP_API_URL + "/api/updateUserDetail", user).then((res) => {
        //     if (res.status !== "2000") {
        //         message.error(res.message);
        //         formState.regLoading = false;
        //         return false;
        //     }
        //     console.log(res);
        //
        //     message.success(res.message);
        //
        //     formState.regLoading = false;
        //     formState.regOpen = false;
        // });
    };

    const onFinishFailed3 = errorInfo => {
        console.log("Failed:", errorInfo);
    };
    //add user-------------
    //菜单列表
    const getMenuList = () => {
      AuthRequest.post(process.env.VUE_APP_API_URL + "/api/menu/list", {}).then((res) => {
        if (res.status !== "2000") {
          message.error(res.message);
          return false;
        }
        res.data.map(item=>{
          item.checked=false
          formState.accountModal.activePanel.push(item.id);
          if(item.child){
            item.child.map(item2=>{
              item2.checked=false
              return item2;
            })
          }
          return item;
        })
        formState.accountModal.menuList = res.data;
      });
    }
    const addAccountRef = ref();
    //显示添加账户弹层
    const showAccountModal = (v,type)=>{
      formState.modalType = type;
      formState.accountModal.id = 0;
      formState.accountModal.username = '';
      formState.accountModal.password = '';
      formState.accountModal.password_confirm = '';
      formState.accountModal.menu_id = [];
      formState.accountModal.showPassword = false;
      formState.accountModal.menuList.map(item=>{
        item.checked=false
        if(item.child.length){
          item.child.map(item2=>{
            item2.checked=false
            return item2;
          })
        }
      })
      if(v){
        formState.accountModal.showPassword = true;
        formState.accountModal.id = v.id;
        formState.accountModal.username = v.username;
        if(formState.modalType == 2){
          if(v.menu_id){
            formState.accountModal.menu_id = v.menu_id;
          }
          formState.accountModal.menuList.map(item=>{
            item.checked=false
            if(v.menu_id.includes(item.id)){
              item.checked = true;
            }
            if(item.child.length){
              let num = 0;
              item.child.map(item2=>{
                item2.checked=false
                if(v.menu_id.includes(item2.id)){
                  item2.checked=true
                  num++;
                }
                return item2;
              })
            }
          })
        }
      }
      formState.accountModal.open = true;
    }
    //关闭添加账户弹层
    const accountModalClose = ()=>{
      formState.accountModal.open = false
      formState.accountModal.password_visible = false;
      formState.accountModal.password_confirm_visible = false;
      addAccountRef.value.resetFields();
    }

    const getAccountList = () => {
      //子账号列表
      AuthRequest.post(process.env.VUE_APP_API_URL + "/api/subAccount/list", {}).then((res) => {
        if (res.status !== "2000") {
          message.error(res.message);
          return false;
        }
        formState.subAccountList = res.data;
      });
      //员工账号列表
      AuthRequest.post(process.env.VUE_APP_API_URL + "/api/employee/list", {}).then((res) => {
        if (res.status !== "2000") {
          message.error(res.message);
          return false;
        }
        formState.employeeList = res.data;
      });
    }
    
    let accountValidateName = async (rule, value) => {
      if (value === "") {
        return Promise.reject("아이디를 입력해주세요");
      } else {
        if (value.length < 5 || value.length > 20) {
          return Promise.reject("아이디는 최소 5자 최대 20자까지 입력해주세요.");
        }
      }
      return Promise.resolve();
    };
    let accountValidatePass = async (rule, value) => {
      if (value === "") {
        if(!formState.accountModal.id){
          return Promise.reject("비밀번호를 입력 해주세요");
        }
      } else {
        if (value.length < 8 || value.length > 20) {
          return Promise.reject("비밀번호는 8자 이상, 20자 이내로 입력해주세요.");
        }
      }
      return Promise.resolve();
    };
    let accountValidatePassConfirm = async (rule, value) => {
      if (value === "") {
        if(!formState.accountModal.id || (formState.accountModal.id && formState.accountModal.password !== '')){
          return Promise.reject("비밀번호가 일치하지 않습니다");
        }
      } else if (value !== formState.accountModal.password) {
        return Promise.reject("비밀번호가 일치하지 않습니다");
      } else {
        return Promise.resolve();
      }
    };
    //表单验证
    const accountRulesRef = reactive({
      username: [
        {
          required: true,
          validator: accountValidateName,
          trigger: "blur"
        }
      ],
      password: [
        {
          required: true,
          validator: accountValidatePass,
          trigger: "blur"
        }
      ],
      password_confirm: [
        {
          required: true,
          validator: accountValidatePassConfirm,
          trigger: "blur"
        }
      ],
    });
    //添加账号
    const addAccount = () => {
      let user = {
        username: formState.accountModal.username,
        password: formState.accountModal.password,
      };
      let url = '/api/subAccount/set';
      if(formState.modalType == 2){
        user.menu_id = formState.accountModal.menu_id;
        url = '/api/employee/set';
        if(!user.menu_id.length){
          message.error('권한을 추가해주세요');
          return false;
        }
      }
      if(formState.accountModal.id){
        user.id = formState.accountModal.id;
      }
      formState.accountModal.loading = true;
      AuthRequest.post(process.env.VUE_APP_API_URL + url, user).then((res) => {
        if (res.status !== "2000") {
          message.error(res.message);
          formState.accountModal.loading = false;
          return false;
        }
        message.success(res.message);
        formState.accountModal.loading = false;
        formState.accountModal.open = false;
        formState.accountModal.password_visible = false;
        formState.accountModal.password_confirm_visible = false;
        addAccountRef.value.resetFields();
        getAccountList();
      });
    };
    //删除账户
    const deleteAccount = (id) =>{
      let url = formState.modalType == 1 ? '/api/subAccount/del' : "/api/employee/del";
      AuthRequest.post(process.env.VUE_APP_API_URL + url, { id }).then((res) => {
        if (res.status !== "2000") {
          message.error(res.message);
          return false;
        }
        message.success(res.message);
        getAccountList();
      });
    }
    // 处理父级复选框选中和取消选中
    const handleParentCheck = (index, event) => {
      event.stopPropagation();
      const parent = formState.accountModal.menuList[index];
      parent.checked = !parent.checked;

      // 更新子级的选中状态
      if (parent.child && parent.child.length) {
        parent.child.forEach(child => {
          child.checked = parent.checked;
          updateMenuId(child.id, child.checked);
        });
      }

      // 更新父级在 menu_id 中的状态
      updateMenuId(parent.id, parent.checked);
    };

    // 处理子级复选框选中和取消选中
    const handleChildCheck = (parentIndex, childIndex, event) => {
      event.stopPropagation();
      const parent = formState.accountModal.menuList[parentIndex];
      const child = parent.child[childIndex];
      child.checked = !child.checked;

      // 更新子级在 menu_id 中的状态
      updateMenuId(child.id, child.checked);

      // 检查所有子项的状态
      const someChecked = parent.child.some(child => child.checked);

      // 如果至少一个子项被选中，更新父级状态为选中
      if (someChecked) {
        parent.checked = true;
      } else {
        // 如果没有子项被选中，不强制改变父级的状态
        // 父级状态保留原状
      }

      // 更新父级在 menu_id 中的状态
      updateMenuId(parent.id, parent.checked);
    };

    // 更新 menu_id 的状态
    const updateMenuId = (id, checked) => {
      if (checked) {
        if (!formState.accountModal.menu_id.includes(id)) {
          formState.accountModal.menu_id.push(id);
        }
      } else {
        const index = formState.accountModal.menu_id.indexOf(id);
        if (index !== -1) {
          formState.accountModal.menu_id.splice(index, 1);
        }
      }
    };

    // 定义面板标题的生成函数
    const panelHeader = (item, index, parentIndex = null) => {
      return h('div', { class: 'panel-header' }, [
        h(Checkbox, {
          checked: item.checked,
          onChange: parentIndex === null
            ? (event) => handleParentCheck(index, event)
            : (event) => handleChildCheck(parentIndex, index, event),
          onClick: (event) => event.stopPropagation() // 防止点击复选框时展开/折叠
        }, () => ''),
        h('span', { class: 'header-text' }, item.title)
      ]);
    };
</script>
<style>
    .user_form .ant-form-item {
        margin-bottom: 0;
    }

    .user_form .ant-form-item-label {
        border: 1px solid #eeeeee;
        background-color: #fafafa;
        width: 170px;
        padding: 10px;
        margin-bottom: -1px;
    }

    .user_form .ant-form-item-control {
        border: 1px solid #eeeeee;
        padding: 10px;
        margin-left: -1px;
        margin-bottom: -1px;
    }

    .user_form .ant-form-item-control:nth-last-child {
        border-bottom: 1px solid #eeeeee;
    }

    .user_form .phone .ant-form-item-control {
        border: none;
        padding: 0;
        margin: 0;
    }

    .user_form .phone .ant-form-item-control:nth-last-child {
        border-bottom: none;
    }

    .ant-form-item .ant-form-item-label >label{
      height:100%;
    }

    .upload .ant-form-item-label >label:before{
      display: inline-block;
      margin-inline-end: 4px;
      color: #ff4d4f;
      font-size: 14px;
      font-family: SimSun, sans-serif;
      line-height: 1;
      content: "*";
    }

    .ant-upload-wrapper.ant-upload-picture-card-wrapper{
      margin-bottom:20px;
    }
    .ant-upload-wrapper.ant-upload-picture-card-wrapper .ant-upload.ant-upload-select{
      position: relative;
    }
    .delete-image{
      position: absolute;
      right:-14px;
      top:0;
      color:red;
    }

    .big-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .big-image img {
      max-width: 90%;
      max-height: 90%;
    }

    .ant-form-show-help{
      display:none;
    }

    .ant-upload-wrapper.ant-upload-picture-card-wrapper{
      margin-bottom: 0;
    }
    .add-account .ant-form-show-help{
      display:block;
    }
    .add-account .ant-form-item-label{
      height: fit-content;
    }
    .add-account .ant-collapse{
      background: inherit;
    }
    .add-account .ant-collapse-header{
      padding: 2px 16px!important;
    }
    .add-account .ant-collapse-content-box .ant-collapse-header{
      padding-left: 50px!important;
    }
    .add-account .ant-collapse-content-box{
      padding: 2px 16px!important;
    }
    .add-account .ant-collapse-content{
      border-top: 0!important;
    }
    .add-account .ant-collapse-item:not(:last-child){
      border-bottom: 0!important;
    }
    .add-account .ant-collapse-content-box .ant-collapse-item{
      height: 26px;
    }
</style>
<style scoped>
.panel-header {
  display: flex;
  align-items: center;
}
.header-text {
  margin-left: 10px;
}
</style>